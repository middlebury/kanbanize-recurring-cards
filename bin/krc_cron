#!/usr/bin/env php
<?php

require_once(dirname(__FILE__)."/../lib/init.php");

$poll_frequency_hours = 24; // @todo - Set this at run-time.
$now = new DateTime();
$start = new DateTime($now->format('Y-m-d H:00:00'));
$end = new DateTime($now->format('Y-m-d H:00:00'));
$end->add(new DateInterval('PT'.($poll_frequency_hours - 1).'H59M59S'));

$data_dir = realpath(dirname(__FILE__)."/../cards");
$data_files = scandir($data_dir);
foreach ($data_files as $file) {
  if (preg_match('/.+\.json$/i', $file)) {
    try {
      $data = json_decode(file_get_contents($data_dir.'/'.$file), true);
      if (is_null($data)) {
        throw new Exception("Error decoding json data from $data_dir/$file");
      }
      $card = new \KanbanizeRecurringCards\Card($data);
      if ($card->recurrsBetween($start, $end)) {
        $card->addToKanbanize($kanbanize);
      }
    } catch (Exception $e) {
      fwrite(STDERR, "Error checking/adding card defined in $data_dir/$file: ".$e->getMessage()."\n");
    }
  }
}
