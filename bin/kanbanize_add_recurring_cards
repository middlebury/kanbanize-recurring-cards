#!/usr/bin/env php
<?php

require_once(dirname(__FILE__)."/../lib/autoload.php");
require_once(dirname(__FILE__)."/../vendor/autoload.php");
require_once(dirname(__FILE__)."/../config.php");


if (empty($config['KANBANIZE']['API_KEY'])) {
  throw new Exception("\$config['KANBANIZE']['API_KEY'] must be defined in config.php");
}
if (empty($config['KANBANIZE']['SUBDOMAIN'])) {
  throw new Exception("\$config['KANBANIZE']['SUBDOMAIN'] must be defined in config.php");
}
$kanbanize = EtuDev_KanbanizePHP_API::getInstance();
$kanbanize->setSubdomain($config['KANBANIZE']['SUBDOMAIN']);
$kanbanize->setApiKey($config['KANBANIZE']['API_KEY']);

date_default_timezone_set('America/New_York'); // @todo - configure this.
$poll_frequency_hours = 24; // @todo - Set this at run-time.
$now = new DateTime();
$start = new DateTime($now->format('Y-m-d H:00:00'));
$end = new DateTime($now->format('Y-m-d H:00:00'));
$end->add(new DateInterval('PT'.($poll_frequency_hours - 1).'H59M59S'));

$data_dir = realpath(dirname(__FILE__)."/../cards");
$data_files = scandir($data_dir);
foreach ($data_files as $file) {
  if (preg_match('/.+\.json$/i', $file)) {
    try {
      $data = json_decode(file_get_contents($data_dir.'/'.$file), true);
      if (is_null($data)) {
        throw new Exception("Error decoding json data from $data_dir/$file");
      }
      $card = new \KanbanizeRecurringCards\Card($data);
      if ($card->recurrsBetween($start, $end)) {
        $card->addToKanbanize($kanbanize);
      }
    } catch (Exception $e) {
      fwrite(STDERR, "Error checking/adding card defined in $data_dir/$file: ".$e->getMessage()."\n");
    }
  }
}
